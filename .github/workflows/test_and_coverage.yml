name: Build, Test & Push to GCP

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
          cache: maven

      - name: Build with Maven (test + coverage)
        run: mvn clean verify

      - name: Generate JaCoCo report
        run: mvn jacoco:report

      - name: Check JaCoCo coverage
        run: |
          covered_lines=$(grep -oP 'covered="\K[0-9]+' target/site/jacoco/jacoco.xml | awk '{s+=$1} END {print s}')
          missed_lines=$(grep -oP 'missed="\K[0-9]+' target/site/jacoco/jacoco.xml | awk '{s+=$1} END {print s}')
          total=$((covered_lines + missed_lines))
          if [ "$total" -eq 0 ]; then echo "No lines to cover."; exit 1; fi
          coverage=$(echo "scale=2; $covered_lines / $total" | bc)
          if (( $(echo "$coverage < 1.0" | bc -l) )); then
            echo "Coverage < 100%: $coverage"; exit 1
          fi

      # AutenticaciÃ³n en GCP
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.COMS_KEY }}

      - name: Configure Docker for Artifact Registry
        uses: google-github-actions/docker-auth@v1
        with:
          location: europe-southwest1
          repository: coms-repository

      - name: Build Docker image
        run: |
          docker build \
            -t europe-southwest1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/coms-repository/coms-image:latest \
            .

      - name: Push Docker image
        run: |
          docker push \
            europe-southwest1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/coms-repository/coms-image:latest
